<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SwiftNotes Database Setup</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f8fafc;
        }
        .container {
            background: white;
            border-radius: 8px;
            padding: 30px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        .status {
            padding: 15px;
            border-radius: 6px;
            margin: 15px 0;
        }
        .status.success { background: #d1fae5; border: 1px solid #10b981; color: #065f46; }
        .status.error { background: #fee2e2; border: 1px solid #ef4444; color: #991b1b; }
        .status.warning { background: #fef3c7; border: 1px solid #f59e0b; color: #92400e; }
        .status.info { background: #dbeafe; border: 1px solid #3b82f6; color: #1e40af; }
        
        .sql-container {
            background: #1f2937;
            color: #f9fafb;
            padding: 20px;
            border-radius: 6px;
            margin: 20px 0;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
        }
        button:hover { background: #2563eb; }
        button:disabled { background: #9ca3af; cursor: not-allowed; }
        
        .step {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
        }
        
        .step h3 {
            margin-top: 0;
            color: #1f2937;
        }
        
        .table-status {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .table-card {
            padding: 15px;
            border-radius: 6px;
            border: 1px solid #e5e7eb;
            text-align: center;
        }
        
        .table-card.exists { background: #d1fae5; border-color: #10b981; }
        .table-card.missing { background: #fee2e2; border-color: #ef4444; }
        
        .progress {
            width: 100%;
            height: 8px;
            background: #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .progress-bar {
            height: 100%;
            background: #10b981;
            transition: width 0.3s ease;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöÄ SwiftNotes Database Setup</h1>
            <p>Automated database schema deployment for SwiftNotes</p>
        </div>

        <div id="status" class="status info">
            <strong>Ready to setup database</strong><br>
            Click "Check Database Status" to begin
        </div>

        <div class="progress">
            <div id="progress-bar" class="progress-bar" style="width: 0%"></div>
        </div>

        <div style="text-align: center; margin: 20px 0;">
            <button onclick="checkDatabase()">Check Database Status</button>
            <button onclick="setupDatabase()" id="setupBtn" disabled>Setup Database</button>
            <button onclick="testDatabase()" id="testBtn" disabled>Test Database</button>
        </div>

        <div id="tableStatus" class="table-status" style="display: none;"></div>

        <div class="step">
            <h3>üìã Manual Setup Instructions</h3>
            <p>If automated setup fails, follow these steps:</p>
            <ol>
                <li>Go to <a href="https://supabase.com/dashboard/project/ppavdpzulvosmmkzqtgy/sql" target="_blank">Supabase SQL Editor</a></li>
                <li>Copy the SQL schema below</li>
                <li>Paste it into the SQL editor</li>
                <li>Click "Run" to execute</li>
                <li>Return here and click "Check Database Status"</li>
            </ol>
            
            <button onclick="copySQL()">üìã Copy SQL Schema</button>
            <button onclick="openSupabase()">üîó Open Supabase SQL Editor</button>
            
            <div id="sqlSchema" class="sql-container">
                Loading SQL schema...
            </div>
        </div>

        <div id="logs" style="margin-top: 30px;"></div>
    </div>

    <script>
        const supabaseUrl = 'https://ppavdpzulvosmmkzqtgy.supabase.co';
        const serviceKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBwYXZkcHp1bHZvc21ta3pxdGd5Iiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc0ODk5MjMyMywiZXhwIjoyMDY0NTY4MzIzfQ.yHF0fEOLMNsUTdsztGfvHGsonournMGiojrn0MhpHXA';
        
        const supabase = window.supabase.createClient(supabaseUrl, serviceKey);
        
        const tables = ['user_profiles', 'isp_tasks', 'notes', 'note_sections', 'user_credits'];
        let tableStatus = {};

        const sqlSchema = `-- SwiftNotes Database Schema
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";

-- Create custom types
DO $$ BEGIN
    CREATE TYPE user_tier AS ENUM ('free', 'paid', 'premium');
EXCEPTION
    WHEN duplicate_object THEN null;
END $$;

DO $$ BEGIN
    CREATE TYPE note_type AS ENUM ('task', 'comment', 'general');
EXCEPTION
    WHEN duplicate_object THEN null;
END $$;

DO $$ BEGIN
    CREATE TYPE transaction_type AS ENUM ('purchase', 'usage', 'refund', 'bonus');
EXCEPTION
    WHEN duplicate_object THEN null;
END $$;

-- User Profiles Table
CREATE TABLE IF NOT EXISTS user_profiles (
    id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
    user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE UNIQUE NOT NULL,
    first_name TEXT,
    last_name TEXT,
    tier user_tier DEFAULT 'free' NOT NULL,
    credits INTEGER DEFAULT 10 NOT NULL,
    writing_style TEXT,
    has_completed_setup BOOLEAN DEFAULT FALSE NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL
);

-- ISP Tasks Table
CREATE TABLE IF NOT EXISTS isp_tasks (
    id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
    user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL,
    description TEXT NOT NULL,
    order_index INTEGER DEFAULT 0 NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL
);

-- Notes Table
CREATE TABLE IF NOT EXISTS notes (
    id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
    user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL,
    title TEXT NOT NULL,
    content JSONB NOT NULL,
    note_type note_type DEFAULT 'general' NOT NULL,
    tokens_used INTEGER,
    cost DECIMAL(10,6),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL
);

-- Note Sections Table
CREATE TABLE IF NOT EXISTS note_sections (
    id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
    note_id UUID REFERENCES notes(id) ON DELETE CASCADE NOT NULL,
    isp_task_id UUID REFERENCES isp_tasks(id) ON DELETE SET NULL,
    user_prompt TEXT NOT NULL,
    generated_content TEXT NOT NULL,
    is_edited BOOLEAN DEFAULT FALSE NOT NULL,
    tokens_used INTEGER,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL
);

-- User Credits Table
CREATE TABLE IF NOT EXISTS user_credits (
    id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
    user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE NOT NULL,
    transaction_type transaction_type NOT NULL,
    amount INTEGER NOT NULL,
    description TEXT NOT NULL,
    reference_id TEXT,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL
);

-- Enable Row Level Security
ALTER TABLE user_profiles ENABLE ROW LEVEL SECURITY;
ALTER TABLE isp_tasks ENABLE ROW LEVEL SECURITY;
ALTER TABLE notes ENABLE ROW LEVEL SECURITY;
ALTER TABLE note_sections ENABLE ROW LEVEL SECURITY;
ALTER TABLE user_credits ENABLE ROW LEVEL SECURITY;

-- Create RLS Policies
CREATE POLICY "Users can view own profile" ON user_profiles FOR SELECT USING (auth.uid() = user_id);
CREATE POLICY "Users can update own profile" ON user_profiles FOR UPDATE USING (auth.uid() = user_id);
CREATE POLICY "Users can insert own profile" ON user_profiles FOR INSERT WITH CHECK (auth.uid() = user_id);

CREATE POLICY "Users can view own ISP tasks" ON isp_tasks FOR SELECT USING (auth.uid() = user_id);
CREATE POLICY "Users can insert own ISP tasks" ON isp_tasks FOR INSERT WITH CHECK (auth.uid() = user_id);
CREATE POLICY "Users can update own ISP tasks" ON isp_tasks FOR UPDATE USING (auth.uid() = user_id);
CREATE POLICY "Users can delete own ISP tasks" ON isp_tasks FOR DELETE USING (auth.uid() = user_id);

CREATE POLICY "Users can view own notes" ON notes FOR SELECT USING (auth.uid() = user_id);
CREATE POLICY "Users can insert own notes" ON notes FOR INSERT WITH CHECK (auth.uid() = user_id);
CREATE POLICY "Users can update own notes" ON notes FOR UPDATE USING (auth.uid() = user_id);
CREATE POLICY "Users can delete own notes" ON notes FOR DELETE USING (auth.uid() = user_id);

CREATE POLICY "Users can view own credit transactions" ON user_credits FOR SELECT USING (auth.uid() = user_id);
CREATE POLICY "Users can insert own credit transactions" ON user_credits FOR INSERT WITH CHECK (auth.uid() = user_id);

-- Function to create user profile on signup
CREATE OR REPLACE FUNCTION public.handle_new_user()
RETURNS TRIGGER AS $$
BEGIN
    INSERT INTO public.user_profiles (user_id, first_name, last_name, credits)
    VALUES (
        NEW.id,
        NEW.raw_user_meta_data->>'first_name',
        NEW.raw_user_meta_data->>'last_name',
        10
    );
    
    INSERT INTO public.user_credits (user_id, transaction_type, amount, description)
    VALUES (
        NEW.id,
        'bonus',
        10,
        'Welcome bonus - free tier starting credits'
    );
    
    RETURN NEW;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- Create trigger for new user signup
DROP TRIGGER IF EXISTS on_auth_user_created ON auth.users;
CREATE TRIGGER on_auth_user_created
    AFTER INSERT ON auth.users
    FOR EACH ROW EXECUTE FUNCTION public.handle_new_user();

-- Create indexes for better performance
CREATE INDEX IF NOT EXISTS idx_user_profiles_user_id ON user_profiles(user_id);
CREATE INDEX IF NOT EXISTS idx_isp_tasks_user_id ON isp_tasks(user_id);
CREATE INDEX IF NOT EXISTS idx_notes_user_id ON notes(user_id);
CREATE INDEX IF NOT EXISTS idx_user_credits_user_id ON user_credits(user_id);`;

        function updateStatus(message, type = 'info') {
            const statusEl = document.getElementById('status');
            statusEl.className = `status ${type}`;
            statusEl.innerHTML = message;
        }

        function updateProgress(percent) {
            document.getElementById('progress-bar').style.width = percent + '%';
        }

        function log(message) {
            const logsEl = document.getElementById('logs');
            const logEntry = document.createElement('div');
            logEntry.className = 'status info';
            logEntry.innerHTML = `<small>${new Date().toLocaleTimeString()}</small><br>${message}`;
            logsEl.appendChild(logEntry);
            logsEl.scrollTop = logsEl.scrollHeight;
        }

        async function checkDatabase() {
            updateStatus('üîç Checking database status...', 'info');
            updateProgress(10);
            log('Starting database status check...');

            tableStatus = {};
            let existingTables = 0;

            for (let i = 0; i < tables.length; i++) {
                const table = tables[i];
                updateProgress(20 + (i * 60 / tables.length));
                
                try {
                    const { data, error } = await supabase
                        .from(table)
                        .select('*')
                        .limit(1);
                    
                    if (error) {
                        tableStatus[table] = false;
                        log(`‚ùå Table '${table}' not found`);
                    } else {
                        tableStatus[table] = true;
                        existingTables++;
                        log(`‚úÖ Table '${table}' exists`);
                    }
                } catch (err) {
                    tableStatus[table] = false;
                    log(`‚ùå Error checking table '${table}': ${err.message}`);
                }
            }

            updateProgress(100);
            displayTableStatus();

            if (existingTables === 0) {
                updateStatus(`‚ùå No tables found (0/${tables.length})<br>Database setup required`, 'error');
                document.getElementById('setupBtn').disabled = false;
            } else if (existingTables < tables.length) {
                updateStatus(`‚ö†Ô∏è Partial setup detected (${existingTables}/${tables.length})<br>Some tables missing`, 'warning');
                document.getElementById('setupBtn').disabled = false;
            } else {
                updateStatus(`‚úÖ All tables found (${existingTables}/${tables.length})<br>Database ready!`, 'success');
                document.getElementById('testBtn').disabled = false;
            }
        }

        function displayTableStatus() {
            const container = document.getElementById('tableStatus');
            container.style.display = 'grid';
            container.innerHTML = '';

            tables.forEach(table => {
                const card = document.createElement('div');
                card.className = `table-card ${tableStatus[table] ? 'exists' : 'missing'}`;
                card.innerHTML = `
                    <strong>${table}</strong><br>
                    <small>${tableStatus[table] ? '‚úÖ Exists' : '‚ùå Missing'}</small>
                `;
                container.appendChild(card);
            });
        }

        async function setupDatabase() {
            updateStatus('üöÄ Setting up database...', 'info');
            log('Database setup is not available through web interface due to Supabase limitations.');
            log('Please use the manual setup instructions below.');
            
            updateStatus('‚ö†Ô∏è Manual setup required<br>Please follow the instructions below', 'warning');
        }

        async function testDatabase() {
            updateStatus('üß™ Testing database functionality...', 'info');
            log('Testing database operations...');

            try {
                // Test basic queries
                for (const table of tables) {
                    if (tableStatus[table]) {
                        const { data, error } = await supabase
                            .from(table)
                            .select('*')
                            .limit(5);
                        
                        if (!error) {
                            log(`‚úÖ ${table}: ${data.length} records accessible`);
                        } else {
                            log(`‚ùå ${table}: ${error.message}`);
                        }
                    }
                }

                updateStatus('‚úÖ Database functionality test completed', 'success');
                log('üéâ Database is ready for use!');
                
            } catch (error) {
                updateStatus('‚ùå Database test failed', 'error');
                log(`‚ùå Test error: ${error.message}`);
            }
        }

        function copySQL() {
            navigator.clipboard.writeText(sqlSchema).then(() => {
                log('üìã SQL schema copied to clipboard!');
            }).catch(err => {
                log('‚ùå Failed to copy SQL schema');
            });
        }

        function openSupabase() {
            window.open('https://supabase.com/dashboard/project/ppavdpzulvosmmkzqtgy/sql', '_blank');
            log('üîó Opened Supabase SQL Editor in new tab');
        }

        // Initialize
        document.getElementById('sqlSchema').textContent = sqlSchema;
        log('SwiftNotes Database Setup Tool initialized');
    </script>
</body>
</html>
